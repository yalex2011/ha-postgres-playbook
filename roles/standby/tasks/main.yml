- name: Install repmgr
  apt:
      name: "repmgr"
      update_cache: yes
      cache_valid_time: 86400
  become: yes

- name: Stop postgres
  service: name=postgresql state=stopped
  become: yes

- name: Setup postgres configuration
  become: yes
  become_user: postgres
  template:
    src: postgresql.conf.j2
    dest: /etc/postgresql/9.5/main/postgresql.conf
    owner: postgres
    group: postgres
    mode: 0640

- name: Setup postgres access configuration
  become: yes
  become_user: postgres
  template:
    src: pg_hba.conf.j2
    dest: /etc/postgresql/9.5/main/pg_hba.conf
    owner: postgres
    group: postgres
    mode: 0644

- name: Main exists?
  stat: path=/var/lib/postgresql/9.5/main
  register: main_stat
  changed_when: False

- name: Remove current data
  file:
    path: /var/lib/postgresql/9.5/main
    state: absent
  become: yes
  become_user: postgres
  when: main_stat.stat.exists

- name: Setup repmgr configuration
  become: yes
  template:
    src: repmgr.conf.j2
    dest: /etc/repmgr.conf
    owner: postgres
    group: postgres
    mode: 0640

- name: Clone the standby
  become: yes
  become_user: postgres
  command: repmgr -h {{ master_address }} -p 5432 -U repmgr -d repmgr -D /var/lib/postgresql/9.5/main --ignore-external-config-files standby clone
  register: clone_command
  changed_when: "'standby clone (using pg_basebackup) complete' in clone_command.stderr"
  failed_when: "'standby clone (using pg_basebackup) complete' not in clone_command.stderr"

- name: Start postgres
  service: name=postgresql state=started
  become: yes

- name: Register standby in repmgr
  become: yes
  become_user: postgres
  command: repmgr standby register
  register: repmgr_command
  changed_when: "'NOTICE: standby node correctly registered for cluster' in repmgr_command.stderr"
  failed_when: "'ERROR:  duplicate key value violates unique constraint' in repmgr_command.stderr"
